@model Medical.ViewModel.CMemberViewModel
@{
    ViewData["Title"] = "AdminMemberList";
    Layout = "~/Areas/Admin/Admin_Layout.cshtml";
}
<div class="btn btn-outline-secondary">
    <a asp-action="AdminCreate" class="fas fa-user-plus">新增會員</a>
</div>

<h1>會員資料管理頁面</h1>
<div class="col-md-3">
    <div>
        <div class="col-xs-4">
            <input type="text" class="form-control" placeholder="搜尋" id="searchingKey"/>
        </div>

        <a>權限篩選</a>

        @*下拉選單篩選，method="post" action="AdminMemberList"*@
        <form name="Role" method="post" action="AdminMemberList">
            <div class="form-group">
                <select asp-for="Role">
                    <option value="2">權限篩選</option>
                    @foreach (var item in Model.roleTypes)
                    {
                        <option value="@item.Role">@item.RoleName</option>
                    }
                </select>
                <input type="submit" value="篩選" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>





<table class="table">
    <thead>
        <tr>
            <th>
                序號
            </th>
            <th>
                信箱
            </th>
            <th>
                姓名
            </th>
            <th>
                使用者ID
            </th>
            <th>
                密碼
            </th>
            <th>
                生日
            </th>
            <th>
                性別
            </th>
            <th>
                健保卡
            </th>
            <th>
                電話
            </th>
            <th>
                權限
            </th>
            <th>
                城市
            </th>
            <th>
                地址
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody id="newtbd"></tbody>
    <tbody id="tbd">
        @{
            int count = 0;

            @foreach (var item in Model.mem)
            {
                count++;

                //前端篩選value=============================================================
                var ro = Model.roleTypes.Where(t => t.Role == item.Role).Select(n => n.RoleName);  //篩選權限
                string showRole = "";
                foreach (var r in ro)
                {
                    showRole = r;          //只會有一個
                }
                //========================
                var gen = Model.MemGender.Where(t => t.GenderId == item.GenderId).Select(n => n.Gender1);
                string showGen = "";
                foreach (var g in gen)
                {
                    showGen = g;
                }
                //========================
                var ci = Model.MemCity.Where(t => t.CityId == item.CityId).Select(n => n.CityName);
                string showCity = "";
                foreach (var c in ci)
                {
                    showCity = c;
                }
                //========================日期格式化，避免生日空值
                string happyBD = "";
                if (item.BirthDay != null)
                    happyBD = item.BirthDay.Value.ToString("yyyy/MM/dd");
                <tr>
                    <td>
                        @count
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Email)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.MemberName)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IdentityId)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Password)
                    </td>
                    <td>
                        @happyBD
                    </td>
                    <td>
                        @showGen
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IcCardNo)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Phone)
                    </td>
                    <td>
                        @showRole
                    </td>
                    <td>
                        @showCity
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Address)
                    </td>
                    <td>
                        @Html.ActionLink("", "Edit", "AdminMemberList", new { id = item.MemberId }, new { Class = "fas fa-edit" })
                        @Html.ActionLink("", "Delete", "AdminMemberList", new { id = item.MemberId }, new { onclick = "return confirm('確定要刪除資料嗎?')", Class = "fas fa-trash" })
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<br />
<br />

@section Scripts{
    <script>
        //使用keyup字串輸進去後觸發
        $("#searchingKey").keyup(function () {
           //檢查空字串要3個等號===
            if ($(this).val() === null || $(this).val() === "") {
                console.log("hihi");
                //$("#tbd").removeProp("hidden");
                $("#tbd").prop('hidden', false);
                //要做一個清空tbody的動作，把查詢表格刪掉
                $("#newtbd").empty();
            }
            else {
                $("#tbd").prop("hidden", "hidden");
                console.log($(this).val());
                keywordnew($(this).val());
            }
        });
        async function keywordnew(keystring) {
             //console.log(keystring);
             const kw = await fetch('@Url.Content("~/Admin/AdminMemberList/keywordnew")' + `?thekey=${keystring}`).then(response => response.json());
            console.log(kw);
            for (var i = 0; i < kw.length; i++) {
                console.log(kw[i].memberId);
                loadnewTbody(kw[i].memberId);
            }
        }
        var count = 0;
        async function loadnewTbody(menID) {
            count++;
            console.log("===================");
            console.log(menID);
            const members = await fetch('@Url.Content("~/Admin/AdminMemberList/loadnewTbody")' + `?memid=${menID}`).then(response => response.json());
            console.log(members);   
            //console.log(members[0]);
            //console.log(members[0].memberName);
            //console.log(members[0].email)
            //console.log(members[0].address)
            //console.log(members[0].phone)
            //物件名稱大小寫會改變，要用console.log去抓
            //===================================================
            web = `<tr id="${members[0].memberId}Div">
                    <td>
                        ${count}
                    </td>
                    <td>
                        ${members[0].email}
                    </td>

                    <td>
                        ${members[0].memberName}
                    </td>
                    <td>
                        ${members[0].identityId}
                    </td>
                 <td>
                        ${members[0].password}
                    </td>
                   <td>
                        
                    </td>
                    <td id="gen${members[0].memberId}">

                    </td>
                    <td>
                       
                    </td>
                    <td>
                       
                    </td>
                   <td>
                        ${members[0].role}
                    </td>
                        <td id="city${members[0].memberId}">

                    </td>
               <td>
                      
                    </td>
                    <td>
                        <a class = "fas fa-edit" href="/Admin/AdminMemberList/Edit/${members[0].memberId}"></a>
                        <a class = "fas fa-trash" onclick = "return confirm('確定刪除?')" href="/Admin/AdminMemberList/Delete/${members[0].memberId}"></a>
                    </td>
                </tr>`
            document.querySelector('#newtbd').innerHTML += web
           }

    </script>
}