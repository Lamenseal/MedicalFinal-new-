@model Medical.ViewModel.CClinicDetailAdminViewModel
@{
    ViewData["Title"] = "AddClinic";
    Layout = "~/Areas/Admin/Admin_Layout.cshtml";
}

<div class="row">

    <div class="col-3">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">新增門診</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="form-group sel">
                            <label>門診類別</label>
                            @*@{
                                    IEnumerable<SelectListItem> Options = new List<SelectListItem>();
                                }
                                @Html.DropDownList("selDept", Options, new { @class = "form-control select2", @style = "width: 100%;" })*@
                            <select id="selDept" class="form-control select2" style="width: 100%;" name="dept">
                            </select>
                        </div>
                        <div class="form-group sel">
                            <label>醫生</label>
                            <select id="selDoctor" class="form-control select2" style="width: 100%;" name="doctor">
                            </select>
                        </div>
                        <div class="form-group sel">
                            <label>
                                診間
                            </label>
                            <select id="selRoom" class="form-control select2" style="width: 100%;" name="room">
                                <option value="1">501</option>
                                <option value="2">502</option>
                                <option value="6">503</option>
                                <option value="7">504</option>
                                <option value="8">505</option>
                                <option value="9">506</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="col-12">
                            <div class="form-group">
                                <label>日期(起)</label>
                                <div class="input-group date" id="reservationdateForm" data-target-input="nearest">
                                    <input id="selDateForm" name="selDateForm" type="text" class="form-control datetimepicker-input" data-target="#reservationdateForm" />
                                    <div class="input-group-append" data-target="#reservationdateForm" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label>日期(迄)</label>
                                <div class="input-group date" id="reservationdateTo" data-target-input="nearest">
                                    <input id="selDateTo" type="text" class="form-control datetimepicker-input" data-target="#reservationdateTo" />
                                    <div class="input-group-append" data-target="#reservationdateTo" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="container">
                            <div class="row">
                                <div class="col-12">
                                    <label>星期</label>
                                    <div class="input-group">
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkday1" name="chkDay" type="checkbox" autocomplete="off" value="1"> 一
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkday2" name="chkDay" type="checkbox" autocomplete="off" value="2"> 二
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkday3" name="chkDay" type="checkbox" autocomplete="off" value="3"> 三
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkday4" name="chkDay" type="checkbox" autocomplete="off" value="4"> 四
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkday5" name="chkDay" type="checkbox" autocomplete="off" value="5"> 五
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label>時段</label>
                                    <div class="input-group">
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkm" name="chkTime" type="checkbox" autocomplete="off" value="1"> 早上
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chka" name="chkTime" type="checkbox" autocomplete="off" value="2"> 下午
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle" data-toggle="buttons" style="margin-right:20px">
                                            <label class="btn btn-outline-primary ">
                                                <input id="chkn" name="chkTime" type="checkbox" autocomplete="off" value="3"> 晚上
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />

                </div>
                <hr />
                <div class="col-12">
                    <button id="btnPreview" type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" style="width:100%">新增</button>
                </div>
            </div>

        </div>
    </div>

    <div class="col-md-9">
        <div class="card card-primary">
            <div class="card-body p-0">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" data-bs-backdrop="static" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div>
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                <div class="modal-body" id="modalbody">
                </div>

                <div class="modal-footer">
                    <button id="btnCreate" type="button" class="btn btn-primary" data-dismiss="modal">新增</button>
                    <button id="btnDelete" type="button" class="btn btn-danger">刪除<span class="badge badge-light" id="repeatCount"></span></button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        var calendar;
        $(document).ready(function ()
        {
            var calendarEl = document.getElementById('calendar');

            let selDept = document.querySelector('#selDept'),
                selDoctor = document.querySelector('#selDoctor'),
                selRoom = document.querySelector('#selRoom'),
                DateForm = document.querySelector('#selDateForm'),
                DateTo = document.querySelector('#selDateTo'),
                days = [], times = [];

            $('#selDept').select2();
            $.ajax({
                url: '/Admin/AdminClinicDetail/Dept',
                dataType: 'json',
                data: function (params) {
                    return {
                        q: params.term,
                        page: params.page
                    };
                }
            })
                .then(function (data) {
                    data.forEach((data) => {
                        const option = new Option(data["deptName"], data["departmentId"]);
                        $('#selDept').append(option).trigger('change');;
                    })

                    $('#selDept').trigger({
                        type: 'select2:select',
                        params: {
                            data: data
                        }
                    });
                })

            //行事曆初始化&讀取資料庫
             calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                themeSystem: 'bootstrap',
                events: "@Url.Content("~/Admin/AdminClinicDetail/loadData")",
                editable: true,
                droppable: true,
                businessHours: [
                    {
                        daysOfWeek: [1, 2, 3, 4, 5],
                        startTime: '09:00',
                        endTime: '12:00'
                    },
                    {
                        daysOfWeek: [1, 2, 3, 4, 5],
                        startTime: '13:00',
                        endTime: '16:00'
                    },
                    {
                        daysOfWeek: [1, 2, 3, 4, 5],
                        startTime: '17:00',
                        endTime: '20:00'
                    }
                ],
                eventDrop: function (info) {
                    const list = {
                        ClinicDetailId: info.event.id,
                        DoctorId: info.event.extendedProps.doctorId,
                        DepartmentId: info.event.extendedProps.deptId,
                        PeriodId: info.event.extendedProps.periodId,
                        RoomId: info.event.extendedProps.roomId,
                        ClinicDate: moment(info.event.start).format("yyyy/MM/D HH:00:00")
                    };

                    Swal.fire({
                        title: '確定變更嗎?',
                        text: "",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '確定'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post('@Url.Content("~/Admin/AdminClinicDetail/Update")', list, function () {
                                calendar.refetchEvents();
                            });
                            Swal.fire(
                                '完成變更',
                                '',
                                'success'
                            );
                        }

                    });
                },
                eventClick: function (info) {
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post('@Url.Content("~/Admin/AdminClinicDetail/Delete")', { id: info.event.id }, function (status) {
                                let title = (status == "true") ? "刪除成功" : "刪除失敗";
                                let information = (status == "true") ? `醫生：${info.event.extendedProps.doctorName} 開診日期：${moment(info.event.start).format("yyyy/MM/D")} ${info.event.extendedProps.periodDetail}  診間：${info.event.extendedProps.roomName}` : '此門診有預約病患，故無法刪除';
                                let result = (status == "true") ? "success" : "error";
                                Swal.fire(
                                    title,
                                    information,
                                    result
                                );
                                calendar.refetchEvents();
                            })
                        }
                    })
                }
            });

            //日期格式化
            $('#reservationdateForm').datetimepicker({
                format: 'yyyy/MM/DD',
            });
            $('#reservationdateTo').datetimepicker({
                format: 'yyyy/MM/DD',
            });
            //預覽視窗開啟
            $("#myModal").on('show.bs.modal', function () {
                $("input[name='chkDay']:checked").each(function (index, item) {
                    days.push($(this).val());
                });
                $("input[name='chkTime']:checked").each(function (index, item) {
                    times.push($(this).val());
                });
                let list = {
                    DoctorId: selDoctor.value,
                    DepartmentId: selDept.value,
                    RoomId: selRoom.value,
                    dateForm: DateForm.value,
                    dateTo: DateTo.value,
                    day: days,
                    time: times
                };

                $.post('@Url.Content("~/Admin/AdminClinicDetail/Preview")', list, function (data) {
                    $('.modal-body').empty();
                    $('.modal-body').html(data);
                }).then(function () {
                    let no = $('#repeatDefault').text();
                    if (Number(no) > 0)
                    {
                        $('#repeatCount').html(no)
                        $('#btnCreate').addClass("hidden")
                    }
                    else
                    {
                        $('#btnCreate').removeClass("hidden")
                        $('#btnDelete').addClass("hidden")
                    }
                })


                $('#btnCreate').click(function () {
                    let count = $('label[name="count"]'),
                        doctorlist = $('label[name="doctorName"]').attr('doctorid'),
                        deptlist = $('label[name="deptName"]').attr('deptid'),
                        periodlist = $('label[name="periodName"]'),
                        Roomlist = $('label[name="RoomName"]').attr('roomid'),
                        Datelist = $('label[name="ClinicDate"]'),
                        obj = [];

                    $.each(count, function (key, value) {
                        var detail = {
                            DoctorId: doctorlist[0],
                            DepartmentId: deptlist[0],
                            periodName: periodlist[0].textContent,
                            RoomId: Roomlist[0],
                            dateForm: Datelist[key].textContent
                        };
                        obj.push(detail);
                    });
                    let objj = { obj: obj };

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Content("~/Admin/AdminClinicDetail/Create")',
                        dataType: 'text',
                        data: objj,
                        success: function () {
                            Swal.fire(
                                '新增成功',
                                '',
                                'success'
                            );
                            calendar.refetchEvents();
                        }
                    });
                })


                $('#btnDelete').on('click', function () {
                $('.repeat').parent().parent().remove();
                Swal.fire({
                    title: '刪除',
                    text: "",
                    icon: 'success'
                });
                $('#repeatCount').html("");
                $(this).addClass("hidden");
            })

        });
            //預覽視窗關閉
            $("#myModal").on('hidden.bs.modal', function () {
                $("input[name='chkDay']:checked").each(function (index, item) {
                    days = [];
                });

                $("input[name='chkTime']:checked").each(function (index, item) {
                    times = [];
                });
                $(".modal-body").empty();
                $('#btnDelete').removeClass("hidden");
            });
            //
            $('#selDept').change(function () {
            $('#selDoctor').select2();

            $.ajax({
                url: '/Admin/AdminClinicDetail/doctorList' + `?deptid=${selDept.value}`,
                dataType: 'json',
                data: function (params) {
                    return {
                        q: params.term, // search term
                        page: params.page
                    };
                }
            }).then(function (data) {
                $('#selDoctor option').remove();
                data.forEach((data) => {
                    const option = new Option(data["doctorName"], data["doctorId"]);
                    $('#selDoctor').append(option).trigger('change');;
                })

                $('#selDoctor').trigger({
                    type: 'select2:select',
                    params: {
                        data: data
                    }
                });
            })
        });

            calendar.render();
        });

    </script>
}
