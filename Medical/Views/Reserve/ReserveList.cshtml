@using Medical.ViewModel;
@model CReserveforShowViewModel
@{
    ViewData["Title"] = "ReserveList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section css
{
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="~/plugins/fontawesome-free/css/all.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="~/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="~/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <!-- Theme style -->
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <!--<link rel="stylesheet" href="~/plugins/fontawesome-free/css/all.min.css">-->





}


<!-- Hero Start -->
<div class="container-fluid bg-primary py-5 hero-header mb-5">
    <div class="row py-3">
        <div class="col-12 text-center">
            <h3 class="display-3 text-white animated zoomIn">線上掛號</h3>
        </div>
    </div>
</div>
<!-- Hero End -->
<hr />


<!-- 查詢預約 Start -->
<div class="container-fluid bg-primary bg-appointment mb-5 wow fadeInUp" data-wow-delay="0.1s" style="margin-top: 90px;">
    <div class="container">
        <div class="row gx-5">
            <div class="col-lg-6 py-5">
                <div class="py-5">
                    <h1 class="display-5 text-white mb-4">We Are A Certified and Award Winning Dental Clinic You Can Trust</h1>
                    <p class="text-white mb-0">Eirmod sed tempor lorem ut dolores. Aliquyam sit sadipscing kasd ipsum. Dolor ea et dolore et at sea ea at dolor, justo ipsum duo rebum sea invidunt voluptua. Eos vero eos vero ea et dolore eirmod et. Dolores diam duo invidunt lorem. Elitr ut dolores magna sit. Sea dolore sanctus sed et. Takimata takimata sanctus sed.</p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="appointment-form h-100 d-flex flex-column justify-content-center text-center p-5 wow zoomIn" data-wow-delay="0.6s">
                    <h1 class="text-white mb-4">線上預約</h1>
                    <form>
                        <div class="row g-3">
                            <div class="col-12 col-sm-6">
                                <select id="dep" class="form-select bg-light border-0" style="height: 55px;">
                                    <option selected>選擇科別</option>
                                    @foreach (var item in Model.departmentList)
                                    {
                                        <option name="@item.DeptName" value="@item.DeptName">@item.DeptName</option>

                                    }
                                </select>
                            </div>
                            <div class="col-12 col-sm-6">
                                <select id="doc" class="form-select bg-light border-0" style="height: 55px;">
                                    <option selected>選擇醫生</option>
                                    @foreach (var item in Model.doctorsList)
                                    {
                                        <option name="@item.DoctorName" value="@item.DoctorName">@item.DoctorName</option>
                                    }
                                </select>
                            </div>
                            <div class="col-12 col-sm-6">
                                <input id="date" type="date" name="txtdate" class="form-control bg-light border-0" placeholder="選擇日期" style="height: 55px;">
                            </div>
                            <div class="col-12">
                                <button id="submit" class="btn btn-dark w-100 py-3" type="submit">查詢門診</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 查詢預約 End -->
@*結果顯現*@
<div class="card">
    <div class="card-header">
        <h3 id="title" class="card-title">查詢結果</h3>
    </div>
    <div class="card-body">
        <div id="example1_wrapper" class="dataTables_wrapper dt-bootstrap4">
            <div class="row">
                <div class="col-sm-12">
                    <table id="example1" class="table table-bordered table-striped" aria-describedby="example1_info">

                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

@*結果顯現結束*@




@*進入預約畫面*@
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">預約</h5>
                <input type="hidden" id="hiddenID" />
                <input type="hidden" id="hiddenID2" />
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card-body pt-0">
                    <div class="row">
                        <div id="re" class="col-7">
                            <h1>確認預約</h1>
                            
                        </div>
                        <div class="col-5 text-center">
                            <img src="../../dist/img/user1-128x128.jpg" alt="user-avatar" class="img-circle img-fluid">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="out" type="button" class="btn btn-secondary" data-bs-dismiss="modal">退出</button>
                <button id="startReserve" type="button" class="btn btn-primary">送出預約</button>
                
            </div>
        </div>
    </div>
</div>


@section scripts
{
    <script>
        let table;
        
        //查詢預約
        $('#submit').click(function (evt) {
            evt.preventDefault();
            $("#example1").empty();
            const doc = $("#doc").val();
            const tre = $("#tre").val();
            const dep = $("#dep").val();
            const date = $("#date").val();
            let count = 0;
            let result = `<thead>
                            <tr>
                                <th class="sorting sorting_asc" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-sort="ascending" aria-label="醫生姓名: activate to sort column descending">醫生姓名</th>
                                <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="治療科別: activate to sort column ascending">治療科別</th>
                                <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="診間: activate to sort column ascending">診間</th>
                                <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="開診日期: activate to sort column ascending">開診日期</th>
                                <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="狀態: activate to sort column ascending">狀態</th>
                                <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label=":動作 activate to sort column ascending"></th>
                            </tr>
                        </thead>`;

            if (doc == "選擇醫生" && dep == "選擇科別" && date =="選擇日期")
            {
                alert("請選擇篩選項目");
            }
            //丟入篩選條件 傳回ReserveResult去篩選
            $.ajax({
                url: '@Url.Content("~/Reserve/ReserveResult")',
                type: "post",
                data: { "doctorname": doc, "departmentname": dep, "treatmentDetailname": tre,"txtdate":date},
                dataType: "json",
                success: function (datas) {
                    $.each(datas, function (index, item) {


                        result += `<tbody><tr class="odd"><td class="dtr-control sorting_1" tabindex="0">${item.doctor}</td>`
                        result += `<td>${item.department}</td>`
                        result += `<td>${item.roomName}</td>`
                        result += `<td>${item.clinicdate} ${item.period}</td>`
                        if (item.online == 0) {
                            result += `<td>剩餘:${item.sequence_number}位</td>`
                            result += `<td><button type="button" id="GoReserve" name=${item.clinicDetailid} onclick="GoReserve()" class="btn btn-primary GoReserve" data-bs-toggle="modal" data-bs-target="#exampleModal">我要預約</button></td></tr></tbody>`
                        }
                        else if (item.online == 1)
                        {
                            result += `<td>已逾期</td>`
                            result += `<td><button type="button" id="GoReserve" disabled = "disabled" name=${item.clinicDetailid} onclick="GoReserve()" class="btn btn-denger GoReserve" data-bs-toggle="modal" data-bs-target="#exampleModal">我要預約</button></td></tr></tbody>`
                        }

                        count++;
                        $("#title").html(`查詢結果共有${count}筆`);
                    })
                   
                    $("#example1").html(result);

                    
                    

                    $(function () {
                        $("#example1").DataTable({
                            "responsive": true, "lengthChange": false, "autoWidth": false,
                            "buttons": ["copy", "excel",], "retrieve": true
                        }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

                    });                 
                }
            })

        })


        //setInterval($(function () {
        //    $("#example1").DataTable({
        //        "responsive": true, "lengthChange": false, "autoWidth": false,
        //        "buttons": ["copy", "excel",], "retrieve": true
        //    }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

        //}), 1000);

        //按下預約 填入modal
        function GoReserve() {
            
            const clinicID = $(event.target).attr("name");
            let result1 = "";
             $.ajax({
                url: '@Url.Content("~/Reserve/GoReserve/")',
                type: "post",
                 data: { "clinicDetailid": clinicID},
                dataType: "json",
                 success: function (datas)
                 {
                     if (datas==null)
                     {
                         
                         /*沒登入跳轉登入畫面*/
                         alert("您尚未成為會員");
                         $('#exampleModal').attr("hidden", "hidden");
                         const back = window.location.href;
                         console.log(back);

                         window.location.href = `@Url.Content("~/Login/Login/?repath=reserve")`;
                     }
                     console.log(datas);
                     $.each(datas, function (index, item) {
                         if (item.memberid > 0)
                         {
                             $("#hiddenID").val(item.clinicDetailid);
                             $("#hiddenID2").val(7 - item.sequence_number);
                             result1 += `<h1 class="lead" style="color:red;"><b>順位:${7 - item.sequence_number}</b></h1>`
                             result1 += `<h2 class="lead"><b>姓名:${item.membername}</b></h2>`
                             result1 += `<h2 class="lead"><b>信箱:${item.email}</b></h2>`
                             result1 += `<h2 class="lead"><b>預約日期:${item.clinicdate} ${item.period}</b></h2>`
                             result1 += `<h2 class="lead"><b>科別:${item.department}</b></h2>`
                             result1 += `<h2 class="lead"><b>醫師:${item.doctor}</b></h2>`
                             result1 += `<h2 class="lead"><b>備註</b></h2><textarea id="Remark_Patient" name="Remark_Patient" rows="5" cols="33"></textarea>`
                         }
                         $("#re").html(result1);

                     })

                 }

            })
        }

        //開始預約
        $("#startReserve").click(function (evt) {
            evt.preventDefault();
            let clinicID = $("#hiddenID").val();
            let Remark = $("#Remark_Patient").val();
            let rank = $("#hiddenID2").val();
            //console.log(clinicID);
            //console.log(Remark);
            //console.log(rank);

            $.ajax({
                url: '@Url.Content("~/Reserve/CreateReserve/")',
                type: "post",
                data: { "clinicDetailid": clinicID, "Remark_Patient": Remark, "rank": rank },
                dataType: "json",
            }).done((datas) => {
                 if (datas==null)
                     {
                         /*預約成功 跳轉頁面*/
                         alert("預約成功");
                         window.location.href = '@Url.Content("~/Home/Index")';
                     }


            })

        })

        

    </script>



    <!-- jQuery -->
    <script src="~/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="~/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables  & Plugins -->
    <script src="~/plugins/datatables/jquery.dataTables.min.js"></script> @*//套件本體*@
    <script src="~/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="~/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="~/plugins/jszip/jszip.min.js"></script>
    <script src="~/plugins/pdfmake/pdfmake.min.js"></script>
    <script src="~/plugins/pdfmake/vfs_fonts.js"></script>
    <script src="~/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="~/plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="~/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
    <!-- AdminLTE App -->
    @*<script src="~/dist/js/adminlte.min.js"></script>*@









}